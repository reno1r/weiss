set dotenv-load := true

# Default recipe
default:
    @just --list

# Run the service
run:
    go run ./cmd/api

# Build the service
build:
    go build -o bin/api ./cmd/api

# Run tests
test:
    go test ./...

# Run tests with verbose output
test-verbose:
    go test -v ./...

# Run tests with coverage
test-coverage:
    go test -cover ./...

# Run tests with coverage report
test-coverage-html:
    go test -coverprofile=coverage.out ./...
    go tool cover -html=coverage.out -o coverage.html
    @echo "Coverage report generated: coverage.html"

# Run tests with race detector
test-race:
    go test -race ./...

# Run tests for a specific package
test-package package:
    go test -v ./{{package}}

# Run tests and show coverage percentage
test-coverage-short:
    go test -cover ./... | grep -E "(ok|FAIL)" | awk '{print $$NF}' | sed 's/coverage: //' | awk '{sum+=$1; count++} END {if (count>0) print "Total coverage: " sum/count "%"}'

# Download dependencies
deps:
    go mod download
    go mod tidy

# Download development dependencies
dev-deps:
    go install github.com/air-verse/air@latest
    go install github.com/pressly/goose/v3/cmd/goose@latest

# Start development with hot reload
dev:
    air . 

# Clean build artifacts
clean:
    rm -rf bin/ api tmp coverage.out coverage.html

# Start development environment
docker-up:
    docker-compose up

# Start development environment in detached mode
docker-up-d:
    docker-compose up -d

# Stop development environment
docker-down:
    docker-compose down

# Stop and remove volumes
docker-down-v:
    docker-compose down -v

# View logs
docker-logs:
    docker-compose logs -f app

# Build production Docker image
docker-build:
    docker build -t weiss-service:latest -f Dockerfile .

# Build development Docker image
docker-build-dev:
    docker-compose build

# Restart services
docker-restart:
    docker-compose restart

# Execute command in app container
docker-exec cmd:
    docker-compose exec app {{cmd}}

# Run tests in container
docker-test:
    docker-compose exec app go test ./...

# Migration commands
# Create a new migration file
migration-create name:
    goose -dir migrations create {{name}} sql

# Run all pending migrations
migration-up:
    goose up

# Rollback the last migration
migration-down:
    goose down

# Rollback all migrations
migration-reset:
    goose reset

# Show migration status
migration-status:
    goose status

# Fix migration version (use with caution)
migration-fix:
    goose fix

# Run migrations in Docker container
migration-up-docker:
    docker-compose exec app goose up

# Check migration status in Docker
migration-status-docker:
    docker-compose exec app status